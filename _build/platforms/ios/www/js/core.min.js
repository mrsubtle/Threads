/*! com.n2d.Shout 05-08-2015 */
Date.prototype.addHours=function(a){return this.setHours(this.getHours()+a),this},Date.prototype.subHours=function(a){return this.setHours(this.getHours()-a),this},Date.prototype.addMinutes=function(a){return this.setMinutes(this.getMinutes()+a),this},Date.prototype.subMinutes=function(a){return this.setMinutes(this.getMinutes()-a),this},Date.prototype.addSeconds=function(a){return this.setSeconds(this.getSeconds()+a),this},Date.prototype.subSeconds=function(a){return this.setSeconds(this.getSeconds()-a),this},Date.prototype.toUTC=function(){return moment&&this.setMinutes(this.getMinutes()+moment().utcOffset()),this};var strings={loginFail:"Login details do not exist. /sadface"},meta={keys:{google:{ios:"AIzaSyC7FWam14hsOU1P_FDtqIDPaUTwiKXPtmg",web:"AIzaSyC7FWam14hsOU1P_FDtqIDPaUTwiKXPtmg",android:"AIzaSyC7FWam14hsOU1P_FDtqIDPaUTwiKXPtmg",current:""},parse:{ApplicationID:"JaafwCCi3YO4JTKKBuQV0Q8HzylzCTgzyI6cfyRb",ClientKey:"EQmULMcPBJrJjKnNW0NDT1KgU7KPIX69brLhXNm4",JavascriptKey:"Hw0SjWNYc7wdP5TuAZE4ry6bHLbKqVqMWXJwwt6m",RESTAPIKey:"8vaBSrqmVD0Ie46WW8ttpU37F2YGN3g9KX8dy2k0"}},userP:{searchRadiusInMeters:5e4},userAttendance:[],userAttendanceLastRetrieved:(new Date).setFullYear(2e3,0,1),userEventsNearby:[],userEventsNearbyLastRetrieved:(new Date).setFullYear(2e3,0,1),lastEvent:{},lastEventSubmittedAt:(new Date).setFullYear(2e3,0,1),lastEventMessages:{},lastEventMessagesTimestamp:(new Date).setFullYear(2e3,0,1),lastEventMessageAt:(new Date).setFullYear(2e3,0,1),lastEventAttendance:{},lastEventAttendanceTimestamp:(new Date).setFullYear(2e3,0,1),lastEventUserAttending:!1,oldLocations:[{a:"324 St. Johns Avenue",lon:-97.1316184,lat:49.9212885},{a:"549 Castle Avenue",lon:-97.0967149,lat:49.9066913},{a:"1234 Corydon Avenue",lon:-97.1731519,lat:49.8640781},{a:"Apt 30, 555 St. Mary Avenue",lon:-97.1518443,lat:49.8890405},{a:"10 Marble Avenue",lon:-97.2116321,lat:49.9362962}],googleMap:{},googleLoc:{},googlePla:{},googlePlaLastResults:[],googlePlaLastResultsTimestamp:(new Date).setFullYear(2e3,0,1),googlePlaLastKeyword:"",googleMapsScriptLoaded:!1,googlePlacesScriptLoaded:!1,userLocation:{},userLocality:null,lastLocationSearch:{},lastKeypressAt:new Date,deviceReady:!1,deviceOnline:!1},touch={addE:function(){return $.Deferred(function(a){$(".touchable").on("mousedown touchstart",function(){$(".touched").removeClass("touched"),$(this).addClass("touched")}),$(".touchable").on("mouseup touchend touchcancel",function(){$(".touched").removeClass("touched")}),a.resolve()}).promise()},remE:function(){return $.Deferred(function(a){$(".touchable").off("mousedown touchstart"),$(".touchable").off("mouseup touchend touchcancel"),a.resolve()}).promise()},initialize:function(){touch.remE().done(touch.addE)},reset:function(){touch.remE().done(touch.addE)}},app={initialize:function(){console.log("App init"),Parse.initialize(meta.keys.parse.ApplicationID,meta.keys.parse.JavascriptKey),meta.keys.google.current=meta.keys.google.web,meta.googleMap=new google.maps.Map($("#mapHolder"),{}),meta.googlePla=new google.maps.places.PlacesService(meta.googleMap),app.bindEvents()},bindEvents:function(){document.addEventListener("deviceready",this.onDeviceReady,!1),document.addEventListener("online",function(){if(meta.deviceOnline=!0,meta.googleMapsScriptLoaded===!1){var a=document.createElement("script");a.type="text/javascript",a.src="https://maps.googleapis.com/maps/api/js?v=3.exp?libraries=places?key="+meta.keys.google.current,document.body.appendChild(a),meta.googleMapsScriptLoaded=!0,meta.googlePlacesScriptLoaded=!0}},!1),document.addEventListener("offline",function(){meta.deviceOnline=!1},!1)},onDeviceReady:function(){console.log("Device is ready"),meta.deviceReady=!0,"ios"==device.platform.toLowerCase()&&(meta.keys.google.current=meta.keys.google.ios),views.initialize(),touch.initialize()}},views={initialize:function(){console.log("View inits"),menu.initialize(),$("body").css("background-color","#000"),Parse.User.current()?views.screens.start.initialize():views.screens.login.initialize()},screens:{login:{initialize:function(){console.log("Loading login screen..."),$.when(views.screens.login.getData()).done(views.screens.login.render())},getData:function(){console.log("Loading login screen data...done.")},render:function(){console.log("Rendering login screen..."),$.when(views.screens.login.remE()).done(function(){$("app screen").addClass("hidden"),views.screens.login.addE(),$("screen#login").removeClass("hidden")})},addE:function(){$("screen#login #btn_goToSignup").hammer().on("tap",function(a){a.preventDefault(),$("app screen").addClass("hidden"),views.screens.signup.initialize()}),$("screen#login #frm_login").on("submit",function(a){$("screen#login #btn_login").prop("disabled",!0),Parse.User.logIn($("screen#login #frm_login #txt_user").val(),$("screen#login #frm_login #txt_pass").val(),{success:function(a){console.log("Parse.User.logIn Success"),console.log(a),views.initialize(),setTimeout(function(){$("screen#login #btn_login").prop("disabled",!1),$("screen#login #frm_login")[0].reset()},500)},error:function(a,b){switch(console.error("Parse.User.logIn Error"),b.code){case 101:$("screen#login #feedback_login").html(strings.loginFail);default:console.error(a),console.error(b)}setTimeout(function(){$("screen#login #feedback_login").html(" "),$("screen#login #btn_login").prop("disabled",!1)},3e3)}}),$("input, select, textarea, button").blur(),a.preventDefault()})},remE:function(){$("screen#login #btn_goToSignup").hammer().off("tap"),$("screen#login #frm_login").off("submit")}},signup:{initialize:function(){console.log("Loading signup screen..."),$.when(views.screens.signup.getData()).done(views.screens.signup.render())},getData:function(){console.log("Loading signup screen data...done.")},render:function(){console.log("Rendering signup screen..."),$.when(views.screens.signup.remE()).done(function(){$("app screen").addClass("hidden"),views.screens.signup.addE(),$("screen#signup").removeClass("hidden")})},addE:function(){$("screen#signup #btn_cancel").hammer().on("tap",function(a){$("app screen").addClass("hidden"),views.screens.login.initialize(),a.preventDefault()}),$("screen#signup #frm_signup #txt_pass2").on("keyup",function(){$(this).val()==$("screen#signup #frm_signup #txt_pass1").val()?($(this).removeClass("bad"),$(this).addClass("good")):($(this).removeClass("good"),$(this).addClass("bad")),0==$("screen#signup #frm_signup .bad").length?$("screen#signup #btn_submit").prop("disabled",!1):$("screen#signup #btn_submit").prop("disabled",!0)}),$("screen#signup #frm_signup").on("submit",function(a){$("screen#signup #btn_signup").prop("disabled",!0);var b=new Parse.User;b.set("firstname",$("screen#signup #frm_signup #txt_fName").val()),b.set("username",$("screen#signup #frm_signup #txt_uName").val()),b.set("email",$("screen#signup #frm_signup #txt_email").val()),b.set("password",$("screen#signup #frm_signup #txt_pass1").val()),b.signUp(null,{success:function(){console.log("Parse.User.signUp Success"),views.initialize()},error:function(a,b){console.log("Parse.User.signUp Error"),console.error(b),setTimeout(function(){$("screen#signup #btn_signup").prop("disabled",!1)},3e3)}}),$("input, select, textarea, button").blur(),a.preventDefault()})},remE:function(){$("screen#signup #btn_cancel").hammer().off("tap"),$("screen#signup #frm_signup #txt_pass2").off("keyup"),$("screen#signup #frm_signup").off("submit")}},start:{initialize:function(){utility.deferredGetLocation(!1,!1).done(function(){views.screens.start.getData(!0).done(function(){views.screens.start.render()})})},getData:function(a){return $.Deferred(function(b){if($("screen#start #btn_refreshData").addClass("disabled"),$("screen#start #btn_refreshData").addClass("infiniteSpin"),a||meta.userAttendanceLastRetrieved<=(new Date).subMinutes(5)||meta.userEventsNearbyLastRetrieved<=(new Date).subMinutes(15)){$("screen#start content #nextEvents list").html("Loading data..."),$("screen#start content #nearbyEvents list").html("Loading data...");var c=_.template($("#tpl_eventListItem").html()),d=Parse.Object.extend("Event"),e=Parse.Object.extend("Attendance"),f=new Parse.Query(e);f.equalTo("user",Parse.User.current()),f.equalTo("status",1),f.include("event"),f.find({success:function(a){console.log("Successfully retrieved accepted Attendance records for current user"),meta.userAttendance=_.sortBy(a,function(a){return a.get("event").get("eventAt")}),$("screen#start content #nextEvents list").html(""),_.each(meta.userAttendance,function(a){var b=a.get("event");if(b.get("eventAt")>=(new Date).subHours(2)&&b.get("eventAt")<=(new Date).addHours(24)){var d={};d.id=b.id,d.name=b.get("name"),d.eventFromNow=moment(b.get("eventAt").valueOf()).fromNow(),$("screen#start content #nextEvents list").append(c(d))}}),0==$("screen#start content #nextEvents list").children().length&&$("screen#start content #nextEvents list").html("No events coming up in the next two days.<br>Why not create one?"),$("screen#start list item").each(function(){var a=$(this).children("date").innerWidth();$(this).children("name").css("right",(a+20)/10+"rem")}),$.when(views.screens.start.remListE()).done(views.screens.start.addListE()),$("screen#start #btn_refreshData").removeClass("disabled"),$("screen#start #btn_refreshData").removeClass("infiniteSpin")},error:function(a){console.error(a)}});var g=new Parse.Query(d);g.equalTo("public",!0),g.notEqualTo("createdBy",Parse.User.current()),g.greaterThan("eventAt",(new Date).subMinutes(45)),g.withinKilometers("eventGeo",Parse.User.current().get("Geo"),meta.userP.searchRadiusInMeters/1e3),g.limit(10),g.find({success:function(a){meta.userEventsNearby=_.sortBy(a,function(a){return a.get("eventAt")}),console.log("Successfully retrieved nearby Event records for current user"),$("screen#start content #nearbyEvents list").html(""),_.each(meta.userEventsNearby,function(a){var b={};b.id=a.id,b.name=a.get("name"),b.eventFromNow=moment(a.get("eventAt").valueOf()).fromNow(),$("screen#start content #nearbyEvents list").append(c(b))}),0==$("screen#start content #nearbyEvents list").children().length&&$("screen#start content #nearbyEvents list").html("No events nearby.<br>Create one now!"),$("screen#start list item").each(function(){var a=$(this).children("date").innerWidth();$(this).children("name").css("right",(a+20)/10+"rem")}),$.when(views.screens.start.remListE()).done(views.screens.start.addListE()),$("screen#start #btn_refreshData").removeClass("disabled"),$("screen#start #btn_refreshData").removeClass("infiniteSpin")},error:function(a){console.error(a)}})}b.resolve()})},render:function(){$("app screen").addClass("hidden"),views.screens.start.remE().done(function(){views.screens.start.addE(),$("screen#start").removeClass("hidden")})},remE:function(){return $.Deferred(function(a){$("screen#start #btn_toggleMenu").hammer().off("tap"),$("screen#start #btn_refreshData").hammer().off("tap"),$("screen#start #btn_addEvent").hammer().off("tap"),a.resolve()})},addE:function(){return $.Deferred(function(a){$("screen#start #btn_toggleMenu").hammer().on("tap",function(){$(this).addClass("spinFaceUp"),setTimeout(menu.show,300)}),$("screen#start #btn_refreshData").hammer().on("tap",function(){views.screens.start.getData(!0)}),$("screen#start #btn_addEvent").hammer().on("tap",function(){views.modals.addEvent.show()}),a.resolve()})},remListE:function(){return $.Deferred(function(a){console.log("Removing list events for Start Screen"),$("screen#start content list item").hammer().off("tap"),a.resolve()})},addListE:function(){return $.Deferred(function(a){console.log("Adding list events for Start Screen"),$("screen#start content list item").hammer().on("tap",function(){$(this).addClass("active"),views.modals.eventDetail.show($(this).data("id"))}),a.resolve()})}}},modals:{addEvent:{initialize:function(){$.when(views.modals.addEvent.remE()).done(views.modals.addEvent.addE())},show:function(){$("modal#addEvent top #btn_save").addClass("disabled"),$("modal#addEvent").scrollTop(0),views.modals.addEvent.initialize(),utility.deferredGetLocation(!1,!1).done(views.modals.addEvent.renderPlaces(""));var a=new Date,b=60*a.getTimezoneOffset()*1e3,c=new Date(a.getTime()-b),d=c.toISOString().replace("Z","");$("modal#addEvent #frm_newEvent #dte_eventAt").val(d),$("screen").not(".hidden").addClass("fadeAway"),$("modal#addEvent").removeClass("viewportBottom"),$("modal#addEvent tabgroup#"+$("modal#addEvent tab.active").attr("for")).removeClass("hidden")},renderPlaces:function(a){"undefined"==typeof a&&(a="");var b=!1;$("modal#addEvent places").html(""),utility.deferredGetPlaces(a,b).done(function(a){var b=_.template($("#tpl_placesListItem").html());_.each(a,function(a){var c={name:a.name,lat:a.geometry.location.lat(),lon:a.geometry.location.lng(),vicinity:a.vicinity};$("modal#addEvent places").append(b(c))}),views.modals.addEvent.remListE().done(function(){views.modals.addEvent.addListE(),touch.reset()})}).fail(function(a){console.error(a.message),$("modal#addEvent places").html("<error>"+a.message+"</error>")})},checkNewEventFormIsValid:function(){return $("modal#addEvent #frm_newEvent #txt_name").val().length>=5&&$("modal#addEvent #frm_newEvent #dte_eventAt").val().length>0&&$("modal#addEvent #frm_newEvent #txt_placesSearch").hasClass("verified")?($("modal#addEvent top #btn_save").removeClass("disabled"),!0):!1},uploadMap:function(){return $.Deferred(function(a){var b=new Parse.GeoPoint({latitude:parseFloat($("modal#addEvent #frm_newEvent #txt_placeLatitude").val()),longitude:parseFloat($("modal#addEvent #frm_newEvent #txt_placeLongitude").val())});utility.getStaticMap(b.latitude,b.longitude).done(function(b){var c=new Parse.File("staticmap.png",{base64:b},"image/png");c.save().then(function(b){a.resolve(b)},function(b){console.error("Could not save staticmap to Parse"),a.reject(b)})})}).promise()},createEvent:function(){meta.lastEventSubmittedAt=new Date;var a=new Parse.GeoPoint({latitude:parseFloat($("modal#addEvent #frm_newEvent #txt_placeLatitude").val()),longitude:parseFloat($("modal#addEvent #frm_newEvent #txt_placeLongitude").val())}),b=moment($("modal#addEvent #frm_newEvent #dte_eventAt").val()).local().valueOf(),c=Parse.Object.extend("Event"),d=new c;views.modals.addEvent.uploadMap().done(function(c){d.set("name",$("modal#addEvent #frm_newEvent #txt_name").val()),d.set("eventAt",new Date(b)),d.set("createdBy",Parse.User.current()),d.set("place",$("modal#addEvent #frm_newEvent #txt_placeName").val()),d.set("vicinity",$("modal#addEvent #frm_newEvent #txt_placeVicinity").val()),d.set("eventGeo",a),d.set("public",$("modal#addEvent #frm_newEvent #chk_public").prop("checked")),d.set("deleted",!1),d.set("map",c),d.set("tags",utility.getHashtags($("modal#addEvent #frm_newEvent #txt_tags").val())),d.save(null,{success:function(a){console.log("Created event ID: "+a.id),views.modals.addEvent.createAttendance(a)},error:function(a){navigator.notification.alert("Could not create this event.  Not sure why, but we're looking at it.",null,"Oops!","OK"),console.error(a)}})})},createAttendance:function(a){if("undefined"!=typeof a){var b=Parse.Object.extend("Attendance"),c=new b;c.set("event",a),c.set("user",Parse.User.current()),c.set("status",1),c.save(null,{success:function(b){console.log("Created attendance ID: "+b.id),views.screens.start.getData(!0),views.modals.addEvent.hide(),views.modals.eventDetail.show(a.id),$("modal#addEvent #frm_newEvent place").removeClass("selected"),$("modal#addEvent #frm_newEvent #txt_placesSearch").removeClass("verified"),$("modal#addEvent #frm_newEvent")[0].reset()},error:function(a){navigator.notification.alert("Could not subscribe to this event.  Not sure why, but we're looking at it.",null,"Oops!","OK"),console.error(a)}})}else console.error("An event object is required for the views.modals.addEvent.createAttendance() Method.")},hide:function(){views.modals.addEvent.remE(),$("modal#addEvent #frm_newEvent")[0].reset(),$("input, textarea, button, select").blur(),$("modal#addEvent").addClass("viewportBottom"),$("screen").not(".hidden").removeClass("fadeAway")},remE:function(){$("modal#addEvent #btn_cancel").hammer().off("tap"),$("modal#addEvent #btn_save").hammer().off("tap"),$("modal#addEvent tabs tab").hammer().off("tap"),$("modal#addEvent #frm_newEvent #txt_name").off("keyup"),$("modal#addEvent #frm_newEvent #dte_eventAt").off("blur"),$("modal#addEvent #frm_newEvent #txt_tags").off("blur"),$("modal#addEvent #frm_newEvent #txt_placesSearch").off("keyup"),$("modal#addEvent #frm_newEvent").off("submit")},addE:function(){$("modal#addEvent #btn_cancel").hammer().on("tap",function(){views.modals.addEvent.hide()}),$("modal#addEvent #btn_save").hammer().on("tap",function(){$("modal#addEvent #frm_newEvent").submit()}),$("modal#addEvent tabs tab").hammer().on("tap",function(){$("modal#addEvent tabs tab").removeClass("active"),$(this).addClass("active"),$("modal#addEvent tabgroup").addClass("hidden"),$("modal#addEvent tabgroup#"+$("modal#addEvent tab.active").attr("for")).removeClass("hidden")}),$("modal#addEvent #frm_newEvent #txt_name").on("keyup",function(){views.modals.addEvent.checkNewEventFormIsValid()}),$("modal#addEvent #frm_newEvent #dte_eventAt").on("blur",function(){if(""==$(this).val()){var a=new Date,b=60*a.getTimezoneOffset()*1e3,c=new Date(a.getTime()-b),d=c.toISOString().replace("Z","");$("modal#addEvent #frm_newEvent #dte_eventAt").val(d)}else moment($(this).val()).local().valueOf()<(new Date).valueOf()&&navigator.notification.alert("That date is in the past. You have to create a future-dated event, silly.",function(){var a=new Date,b=60*a.getTimezoneOffset()*1e3,c=new Date(a.getTime()-b),d=c.toISOString().replace("Z","");$("modal#addEvent #frm_newEvent #dte_eventAt").val(d)},"Oops!","Oh right, I forgot!");views.modals.addEvent.checkNewEventFormIsValid()}),$("modal#addEvent #frm_newEvent #txt_tags").on("blur",function(){console.log(utility.getHashtags($(this).val())),views.modals.addEvent.checkNewEventFormIsValid()}),$("modal#addEvent #frm_newEvent #txt_placesSearch").on("keyup",function(){views.modals.addEvent.renderPlaces($(this).val().trim()),$("modal#addEvent #frm_newEvent place").removeClass("selected"),$("modal#addEvent #frm_newEvent #txt_placesSearch").removeClass("verified"),$("modal#addEvent #frm_newEvent #txt_placeLongitude").val(""),$("modal#addEvent #frm_newEvent #txt_placeLatitude").val(""),$("modal#addEvent #frm_newEvent #txt_placeVicinity").val(""),$("modal#addEvent #frm_newEvent #txt_placeName").val(""),views.modals.addEvent.checkNewEventFormIsValid()}),$("modal#addEvent #frm_newEvent").on("submit",function(a){meta.lastEventSubmittedAt>=(new Date).subSeconds(5)&&views.modals.addEvent.checkNewEventFormIsValid()?console.log("Prevented event spam"):views.modals.addEvent.createEvent(),a.preventDefault()})},remListE:function(){return $.Deferred(function(a){$("modal#addEvent places place").hammer().off("tap"),a.resolve()}).promise()},addListE:function(){return $.Deferred(function(a){$("modal#addEvent places place").hammer().on("tap",function(){$("modal#addEvent #frm_newEvent place").removeClass("selected"),$(this).toggleClass("selected"),$(this).hasClass("selected")?($("modal#addEvent #frm_newEvent #txt_placeLongitude").val($(this).data("lon")),$("modal#addEvent #frm_newEvent #txt_placeLatitude").val($(this).data("lat")),$("modal#addEvent #frm_newEvent #txt_placeVicinity").val($(this).children("name").text().trim()),$("modal#addEvent #frm_newEvent #txt_placeName").val($(this).children("vicinity").text().trim()),$("modal#addEvent #frm_newEvent #txt_placesSearch").val($(this).children("name").text().trim()),$("modal#addEvent #frm_newEvent #txt_placesSearch").addClass("verified")):($("modal#addEvent #frm_newEvent #txt_placeLongitude").val(""),$("modal#addEvent #frm_newEvent #txt_placeLatitude").val(""),$("modal#addEvent #frm_newEvent #txt_placeVicinity").val(""),$("modal#addEvent #frm_newEvent #txt_placeName").val(""),$("modal#addEvent #frm_newEvent #txt_placesSearch").val(""),$("modal#addEvent #frm_newEvent #txt_placesSearch").removeClass("verified")),views.modals.addEvent.checkNewEventFormIsValid()}),a.resolve()}).promise()}},eventDetail:{initialize:function(){$.when(views.modals.eventDetail.remE()).done(views.modals.eventDetail.addE())},show:function(a){"undefined"!=typeof a?($("modal#eventDetail bottom #frm_eventMessage").addClass("hidden"),$("modal#eventDetail bottom #btn_attendEvent").removeClass("hidden"),$.when(views.modals.eventDetail.getData(a)).done(views.modals.eventDetail.initialize()),$("screen").not(".hidden").addClass("fadeAway"),$("modal#eventDetail").removeClass("viewportBottom")):console.error("You must specify an eventID when loading modal#eventDetail")},getData:function(a){return $.Deferred(function(b){var c=Parse.Object.extend("Event"),d=new Parse.Query(c);d.get(a,{success:function(a){meta.lastEvent=a,console.log(a.get("eventAt")),console.log(a.get("eventAt").valueOf());a.get("eventGeo").latitude,a.get("eventGeo").longitude;$("modal#eventDetail name").html(a.get("name")),$("modal#eventDetail date fromnow").html(moment(a.get("eventAt").valueOf()).fromNow()),$("modal#eventDetail fulldate").html(utility.formatDate(a.get("eventAt"))),$("modal#eventDetail place").html(a.get("place")),a.get("vicinity").length>0&&$("modal#eventDetail vicinity").html(a.get("vicinity")),$("modal#eventDetail top").css("background-image","url("+a.get("map").url()+")"),views.modals.eventDetail.getMessages(a,!0),views.modals.eventDetail.getAttendance(a,!0)},error:function(a,c){console.error(c),b.reject(c)}})})},getMessages:function(a,b){return $.Deferred(function(c){if($("modal#eventDetail content").html("Loading messages..."),"undefined"==typeof b&&(b=!1),meta.lastEventMessagesTimestamp<=(new Date).subMinutes(2)||b){var d=Parse.Object.extend("Message"),e=new Parse.Query(d);e.equalTo("event",a),e.notEqualTo("flagged",!0),e.include("user"),e.ascending("createdAt"),e.find({success:function(a){meta.lastEventMessages=a,meta.lastEventMessagesTimestamp=new Date,$("modal#eventDetail content").html(""),0==a.length?$("modal#eventDetail content").html("No messages in this Event yet."):views.modals.eventDetail.renderMessages(a).done(function(){$("modal#eventDetail content").scrollTop($("modal#eventDetail content message:last-child").offset().top)}),c.resolve()},error:function(a){console.error(a),c.reject(a)}})}else views.modals.eventDetail.renderMessages(meta.lastEventMessages).done(function(){$("modal#eventDetail content").scrollTop($("modal#eventDetail content message:last-child").offset().top)}),c.resolve()})},renderMessages:function(a){return $.Deferred(function(b){$("modal#eventDetail content").html("");var c=_.template($("#tpl_eventMessage").html());_.each(a,function(a){var b={};b.id=a.id,b.userName=a.get("user").get("firstname"),b.text=a.get("text"),b.date=moment(a.createdAt.valueOf()).fromNow(),$("modal#eventDetail content").append(c(b))}),b.resolve()})},getAttendance:function(a,b){return $.Deferred(function(c){if("undefined"==typeof b&&(b=!1),meta.lastEventAttendanceTimestamp<=(new Date).subMinutes(5)||b){var d=Parse.Object.extend("Attendance"),e=new Parse.Query(d);e.equalTo("event",a),e.equalTo("status",1),e.include("user"),e.find({success:function(a){meta.lastEventAttendance=a,meta.lastEventUserAttending=!1,meta.lastEventAttendanceTimestamp=new Date,$("modal#eventDetail top #btn_attendees label").html(""+a.length),_.each(a,function(a){a.get("user").id==Parse.User.current().id&&(meta.lastEventUserAttending=!0)}),meta.lastEventUserAttending?($("modal#eventDetail bottom #frm_eventMessage").removeClass("hidden"),$("modal#eventDetail bottom #btn_attendEvent").addClass("hidden")):($("modal#eventDetail bottom #frm_eventMessage").addClass("hidden"),$("modal#eventDetail bottom #btn_attendEvent").removeClass("hidden")),c.resolve()},error:function(a){navigator.notification.alert("Could not retrieve list of Attendees. Go back and try to load this event again.",function(){console.log("Closed attendee fail alert")},"Oops!","OK"),console.log(a),c.reject(a)}})}})},hide:function(){views.modals.eventDetail.remE(),$("modal#eventDetail").addClass("viewportBottom"),$("screen").not(".hidden").removeClass("fadeAway"),setTimeout(function(){$("screen list item").removeClass("active"),$("modal#eventDetail #frm_eventMessage").addClass("hidden"),$("modal#eventDetail #btn_attendEvent").addClass("hidden"),$("modal#eventDetail top").css("background-image","none"),$("modal#eventDetail event name, modal#eventDetail event date fromnow, modal#eventDetail event date fulldate").html(""),$("modal#eventDetail content").html("")},500)},remE:function(){$("modal#eventDetail #btn_back").hammer().off("tap"),$("modal#eventDetail #btn_location").hammer().off("tap"),$("modal#eventDetail #btn_attendance").hammer().off("tap"),$("modal#eventDetail #btn_attendEvent").hammer().off("tap"),$("modal#eventDetail #frm_eventMessage").off("submit"),$("modal#eventDetail #btn_options").hammer().off("tap")},addE:function(){$("modal#eventDetail #btn_back").hammer().on("tap",function(){views.modals.eventDetail.hide()}),$("modal#eventDetail #btn_location").hammer().on("tap",function(){alert("Location tapped - launch actionsheet here")}),$("modal#eventDetail #btn_attendance").hammer().on("tap",function(){alert("Attendance count tapped - launch attendee list here")}),$("modal#eventDetail #btn_attendEvent").hammer().on("tap",function(){navigator.notification.confirm("You'll be there on "+utility.formatDate(meta.lastEvent.get("eventAt"))+".",function(a){if(1==a){var b=Parse.Object.extend("Attendance"),c=new b;c.set("user",Parse.User.current()),c.set("event",meta.lastEvent),c.set("status",1),c.save(null,{success:function(){views.screens.start.getData(!0),views.modals.eventDetail.show(meta.lastEvent.id)},error:function(a){navigator.notification.alert("Could not join this event.  Not sure why, but we're looking at it.",null,"Oops!","OK"),console.error(a)}})}},meta.lastEvent.get("name"),["You bet!","No thanks"])}),$("modal#eventDetail #frm_eventMessage").on("submit",function(a){if(meta.lastEventMessageAt>=(new Date).subSeconds(1.5)||""==$("modal#eventDetail #frm_eventMessage #txt_text").val())console.log("Prevented message spam");else{meta.lastEventMessageAt=new Date;var b=Parse.Object.extend("Message"),c=new b;c.set("text",$("modal#eventDetail #frm_eventMessage #txt_text").val()),c.set("user",Parse.User.current()),c.set("event",meta.lastEvent),c.save(null,{success:function(a){meta.lastEventMessages.push(a),views.modals.eventDetail.getMessages(meta.lastEvent,!1),$("modal#eventDetail #frm_eventMessage")[0].reset(),$("modal#eventDetail #frm_eventMessage #btn_sendMessage").prop("disabled",!0),setTimeout(function(){$("modal#eventDetail #frm_eventMessage #btn_sendMessage").prop("disabled",!1)},1500)},error:function(a){navigator.notification.alert("Could not send your message.  Not sure why, but we're looking at it.",null,"Oops!","OK"),console.log(a)}})}a.preventDefault()}),$("modal#eventDetail #btn_options").hammer().on("tap",views.actionsheets.eventDetailOptions.show)},remListE:function(){return $.Deferred(function(a){a.resolve()}).promise()},addListE:function(){return $.Deferred(function(a){a.resolve()}).promise()}}},actionsheets:{eventDetailOptions:{initialize:function(){$.when(views.actionsheets.eventDetailOptions.remE()).done(views.actionsheets.eventDetailOptions.addE())},show:function(){meta.lastEvent.get("createdBy").id==Parse.User.current().id?($("actionsheet#eventDetailOptions action#editEvent").removeClass("disabled"),$("actionsheet#eventDetailOptions action#deleteEvent").removeClass("disabled"),touch.reset()):($("actionsheet#eventDetailOptions action#editEvent").addClass("disabled"),$("actionsheet#eventDetailOptions action#deleteEvent").addClass("disabled")),views.actionsheets.eventDetailOptions.initialize(),$("actionsheet#eventDetailOptions").removeClass("hidden")},hide:function(){setTimeout(function(){$("actionsheet#eventDetailOptions").addClass("hidden")},600)},remE:function(){return $.Deferred(function(a){$("actionsheet#eventDetailOptions action").hammer().off("tap"),a.resolve()}).promise()},addE:function(){return $.Deferred(function(a){$("actionsheet#eventDetailOptions action#openInMaps.touchable").hammer().on("tap",function(){"ios"==device.platform.toLowerCase()?window.open("http://maps.apple.com/?q="+meta.lastEvent.get("eventGeo").latitude+","+meta.lastEvent.get("eventGeo").longitude,"_system"):"android"==device.platform.toLowerCase()&&window.open("geo:"+meta.lastEvent.get("eventGeo").latitude+","+meta.lastEvent.get("eventGeo").longitude,"_system"),views.actionsheets.eventDetailOptions.hide()}),$("actionsheet#eventDetailOptions action#editEvent.touchable").not(".disabled").hammer().on("tap",function(){alert("Edit event code here")}),$("actionsheet#eventDetailOptions action#reportEvent.touchable").hammer().on("tap",function(){alert("Report event code here")}),$("actionsheet#eventDetailOptions action#deleteEvent.touchable").not(".disabled").hammer().on("tap",function(){alert("Delete event code here")}),$("actionsheet#eventDetailOptions action#cancel.touchable").hammer().on("tap",views.actionsheets.eventDetailOptions.hide),a.resolve()}).promise()}}}},menu={initialize:function(){$("menu").addClass("menu-left"),$("app").removeClass("tiltBack"),$.when(menu.remE()).done(menu.addE())},show:function(){console.log("Showing Menu"),$("app").addClass("tiltBack"),$("menu").removeClass("menu-left"),$(".touched").removeClass("touched"),$("app screen").not(".hidden").each(function(a,b){window.views.screens[$(b).attr("id")].remE()}),setTimeout(function(){$("app").hammer().one("tap hold",function(){menu.hide()})},500)},hide:function(){console.log("Hiding Menu"),$("menu").addClass("menu-left"),$("app").removeClass("tiltBack"),$("app screen").not(".hidden").each(function(a,b){window.views.screens[$(b).attr("id")].addE()}),setTimeout(function(){$(".spinFaceUp").removeClass("spinFaceUp"),$(".touched").removeClass("touched")},300)},remE:function(){$("menu #btn_menu_locations").hammer().off("tap"),$("menu #btn_menu_favs").hammer().off("tap"),$("menu #btn_menu_settings").hammer().off("tap"),$("menu #btn_menu_logout").hammer().off("tap")},addE:function(){$("menu #btn_menu_locations").hammer().on("tap",function(){}),$("menu #btn_menu_favs").hammer().on("tap",function(){}),$("menu #btn_menu_settings").hammer().on("tap",function(){}),$("menu #btn_menu_logout").hammer().on("tap",function(){Parse.User.logOut(),views.initialize()})}},utility={getHashtags:function(a){for(var b,c=/(?:^|\s)(?:#)([a-zA-Z\d_-]+)/gm,d=[];b=c.exec(a);)d.push(b[1]);var e=_.uniq(d,!0);return e},formatDate:function(a){return moment(a.valueOf()).format("MMM Do, h:mm A")},roundDate:function(a){if("undefined"==typeof a)var a=new Date;moment().utc(a).isUTC()},dateDiff:function(a,b){return b||(b=new Date),a-b},deg2rad:function(a){return a*(Math.PI/180)},getDist:function(a,b){var c={lon:a,lat:b},d=6371,e=utility.deg2rad(parseFloat(Parse.User.current().get("Geo").latitude)-parseFloat(c.lat)),f=utility.deg2rad(parseFloat(Parse.User.current().get("Geo").longitude)-parseFloat(c.lon)),g=Math.sin(e/2)*Math.sin(e/2)+Math.cos(utility.deg2rad(parseFloat(c.lat)))*Math.cos(utility.deg2rad(parseFloat(Parse.User.current().get("Geo").latitude)))*Math.sin(f/2)*Math.sin(f/2),h=2*Math.atan2(Math.sqrt(g),Math.sqrt(1-g)),i=d*h,j=+i.toFixed(2);return j},getTimeToDist:function(a,b){b||(b=35);var c=a/b*60,d=+c.toFixed(0);return d},openAppleMaps:function(a,b){window.location.href="maps://maps.apple.com/?q="+b+","+a},geolocate:function(a){var b={};$.getJSON("https://maps.googleapis.com/maps/api/geocode/json?address="+encodeURI(a)+"&key="+meta.keys.google.current).done(function(a){return meta.tempGeolocate=a,b=a.results[0].geometry.location,meta.locations=a.results,b}).fail(function(a,b,c){console.error(c)})},reverseGeoCode:function(a,b,c){var d="https://maps.googleapis.com/maps/api/geocode/json?latlng="+a+","+b+"&key="+meta.keys.google.current;return $.Deferred(function(a){$.getJSON(d).done(function(b){console.log("Got address(es)"),meta.lastLocationSearch=b,a.resolve(b)
}).fail(function(b,c,d){console.error(d),a.reject(d)}).always(c)})},delayGeolocate:function(a){return $.Deferred(function(b){a?$.getJSON("https://maps.googleapis.com/maps/api/geocode/json?address="+encodeURI(a)+"&key="+meta.keys.google.current).done(function(a){b.resolve(a)}).fail(function(a,c,d){b.reject(d)}):b.reject("No address specified.")}).promise()},deferredGetLocation:function(a,b){return $.Deferred(function(c){utility.dateDiff(Parse.User.current().get("GeoAt"))<=3e5||1==b?1==a?navigator.geolocation?navigator.geolocation.getCurrentPosition(function(a){if("undefined"!=typeof a){var b=new Parse.GeoPoint({latitude:a.coords.latitude,longitude:a.coords.longitude});Parse.User.current().set("Geo",b),Parse.User.current().set("GeoAt",new Date),Parse.User.current().save(null,{success:function(){console.log("Parse: Updated User's Geolocation")},error:function(a,b){console.error("Parse: Failed to update User's Geolocation"),console.error(b)}}),c.resolve(b)}else c.reject("Unable to retrieve position from webview.")}):(c.reject({error:"Browser doesn't support HTML5 Geolocation."}),console.error("Browser doesn't support HTML5 Geolocation.")):(console.log("Fetching position via Cordova..."),navigator.geolocation.getCurrentPosition(function(a){console.log(a);var b=new Parse.GeoPoint({latitude:a.coords.latitude,longitude:a.coords.longitude});Parse.User.current().set("Geo",b),Parse.User.current().set("GeoAt",new Date),Parse.User.current().save(null,{success:function(){console.log("Parse: Updated User's Geolocation")},error:function(a,b){console.error("Parse: Failed to update User's Geolocation"),console.error(b)}}),meta.googleLoc=new google.maps.LatLng(Parse.User.current().get("Geo").latitude,Parse.User.current().get("Geo").longitude),c.resolve(b)},function(a){console.error("Phonegap GEO FAILED"),console.error(a),c.reject({error:a.message})},{maximumAge:3e3,timeout:3e4,enableHighAccuracy:!0})):c.resolve(Parse.User.current().get("Geo"))}).promise()},deferredGetAddress:function(a){var b;return b=a?"https://maps.googleapis.com/maps/api/geocode/json?latlng="+a.latitude+","+a.longitude+"&key="+meta.keys.google.current:"https://maps.googleapis.com/maps/api/geocode/json?latlng="+Parse.User.current().get("Geo").latitude+","+Parse.User.current().get("Geo").longitude+"&key="+meta.keys.google.current,$.getJSON(b).done(function(a){console.log("Got address(es)"),meta.lastLocationSearch=a}).fail(function(a,b,c){console.error(c)})},deferredGetPlaces:function(a,b){return"undefined"==typeof a&&(a=""),$.Deferred(function(c){b||0==meta.googlePlaLastResults.length||a!=meta.googlePlaLastKeyword?(meta.googlePlaLastKeyword=a,meta.googlePla.nearbySearch({location:meta.googleLoc,radius:meta.userP.searchRadiusInMeters,keyword:meta.googlePlaLastKeyword},function(b,d){meta.googlePlaLastResults=b,d==google.maps.places.PlacesServiceStatus.OK?c.resolve(b):c.reject({message:"No results nearby for <keyword>"+a+"</keyword>.<br>Try being more specific."})})):c.resolve(meta.googlePlaLastResults)}).promise()},getStaticMap:function(a,b){return $.Deferred(function(c){var d="http://maps.googleapis.com/maps/api/staticmap?center="+a+","+b+"&zoom=15&scale=2&format=png&sensor=false&size=640x640&maptype=roadmap&style=element:labels.icon|visibility:off&style=feature:administrative.country|element:labels|visibility:off&style=feature:administrative.province|element:labels|visibility:off&style=feature:road|visibility:simplified&style=feature:road.local|element:labels|visibility:off&style=feature:road.arterial|element:labels.icon|visibility:off&style=feature:water|visibility:simplified&style=feature:landscape|visibility:simplified&style=feature:poi|visibility:simplified&style=element:labels|visibility:off&style=feature:transit|element:geometry|visibility:off&style=feature:road",e=new Image,f=document.getElementById("staticMapHolder"),g=f.getContext("2d");e.onload=function(){g.drawImage(e,0,0),c.resolve(f.toDataURL("image/png",1).substr(22))},e.src=d}).promise()}};$(function(){app.initialize()});